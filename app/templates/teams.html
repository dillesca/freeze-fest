<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Manage Teams • Freeze Fest</title>
    <link rel="icon" type="image/png" href="{{ request.url_for('static', path='img/freezefest.png') }}">
    <link rel="stylesheet" href="{{ request.url_for('static', path='css/style.css') }}">
    {% if cast_sender_enabled %}
    {% include '_cast_sender_head.html' %}
    {% endif %}
  </head>
  <body>
    {% set current_target = request.url.path %}
    {% if request.url.query %}
      {% set current_target = current_target + '?' + request.url.query %}
    {% endif %}
    <header class="page-header">
      <div class="page-header__inner">
        <div class="admin-banner" role="navigation" aria-label="Admin and casting">
          {% if cast_sender_enabled %}
          <google-cast-launcher class="cast-launcher" aria-label="Cast to TV"></google-cast-launcher>
          {% endif %}
          {% if is_admin %}
          <form method="post" action="{{ request.url_for('admin_logout') }}" class="admin-banner__logout">
            <input type="hidden" name="next" value="{{ current_target }}" />
            <button type="submit">Log out</button>
          </form>
          {% else %}
          <a href="{{ request.url_for('admin_login') }}?next={{ current_target | urlencode }}">Admin Login</a>
          {% endif %}
        </div>
        <div class="site-logo" role="presentation">
          <img src="{{ request.url_for('static', path='img/freezefest.png') }}" alt="Freeze Fest mascot: a cartoon mosquito freezing inside a circle" loading="lazy" />
        </div>
        <h1>Manage {{ event.name }} Teams</h1>
        <p class="page-subtitle">
          Rosters below are tied to the {{ event.event_date.strftime('%Y') }} showdown on {{ event.event_date.strftime('%B %d') }}.
        </p>
        <nav class="page-nav" aria-label="Primary">
          <a href="{{ request.url_for('index') }}">RSVP</a>
          <a href="{{ request.url_for('team_directory') }}" aria-current="page">Register a Team</a>
          <a href="{{ request.url_for('bracket') }}">View Bracket</a>
          <a href="{{ request.url_for('photos') }}">Photos</a>
          <a href="{{ request.url_for('events_page') }}">Past Events</a>
          <a href="{{ request.url_for('game_rules') }}">Game Rules</a>
          <a href="{{ request.url_for('about_page') }}">About</a>
        </nav>
      </div>
    </header>

    <main class="content">
      <section class="panel">
        <h2>Create a Team</h2>
        <p class="section-intro">
          Teams compete in pairs — one partner and one partner only. Pick a name that represents both of you, then submit!
        </p>
        <form method="post" action="{{ request.url_for('create_team') }}" class="participants-form team-form">
          <label for="team-name">Team name</label>
          <input
            id="team-name"
            name="name"
            type="text"
            placeholder="e.g., Snowbound Sprinters"
            value="{{ form_value }}"
            required
            minlength="2"
            maxlength="100"
          />

          <label for="team-member-one">Player one</label>
          <input
            id="team-member-one"
            name="member_one"
            type="text"
            placeholder="Player one (e.g., Taylor Frost)"
            value="{{ form_member_one }}"
            maxlength="100"
          />

          <label for="team-member-two">Player two</label>
          <input
            id="team-member-two"
            name="member_two"
            type="text"
            placeholder="Player two (e.g., Devon Snow)"
            value="{{ form_member_two }}"
            maxlength="100"
          />

          <p class="form-hint">Player names are optional but help fans follow the action.</p>

          {% if form_error %}
          <p class="form-error">{{ form_error }}</p>
          {% endif %}

          {% if success_message %}
          <p class="form-success">{{ success_message }}</p>
          {% endif %}

          <div class="form-footer">
            <button type="submit">Add Team</button>
            <a class="text-link" href="{{ request.url_for('bracket') }}">View bracket →</a>
          </div>
        </form>
      </section>

      <section class="panel">
        <h2>Free Agent Pool</h2>
        <p>
          Flying solo? Join the pool and we'll auto-match you with the next available player to create a new team.
        </p>
        <form method="post" action="{{ request.url_for('register_free_agent') }}" class="participants-form team-form">
          <label for="free-agent-name">Full name</label>
          <input id="free-agent-name" name="name" type="text" required maxlength="100" placeholder="Taylor Frost" />

          <label for="free-agent-note">Notes (optional)</label>
          <textarea id="free-agent-note" name="note" rows="2" maxlength="100" placeholder="Preferred game or fun fact"></textarea>

          <button type="submit">Join Free Agent Pool</button>
        </form>

        {% if free_agent_error %}
        <p class="form-error">{{ free_agent_error }}</p>
        {% endif %}
        {% if free_agent_success %}
        <p class="form-success">{{ free_agent_success }}</p>
        {% endif %}

        <h3>Waiting for a teammate</h3>
        {% if free_agents_pending %}
        <ul class="free-agent-list">
          {% for agent in free_agents_pending %}
          <li class="free-agent-list__item">
            <div class="free-agent-card">
              <span class="free-agent-name">{{ agent.name }}</span>
              <span class="free-agent-meta">Joined the pool</span>
              {% if agent.note %}
              <p class="free-agent-note">“{{ agent.note }}”</p>
              {% endif %}
            </div>
            <details class="inline-editor">
              <summary>Manage {{ agent.name }}</summary>
              <form method="post" action="{{ request.url_for('update_free_agent', agent_id=agent.id) }}" class="inline-form">
                <label for="agent-name-{{ agent.id }}">Full name</label>
                <input id="agent-name-{{ agent.id }}" name="name" type="text" value="{{ agent.name }}" required minlength="1" maxlength="100" />

                <label for="agent-note-{{ agent.id }}">Notes</label>
                <textarea id="agent-note-{{ agent.id }}" name="note" rows="2" maxlength="100">{{ agent.note or '' }}</textarea>

                <label for="agent-status-{{ agent.id }}">Status</label>
                <select id="agent-status-{{ agent.id }}" name="status">
                  <option value="pending" {% if agent.status == 'pending' %}selected{% endif %}>Pending</option>
                  <option value="paired" {% if agent.status == 'paired' %}selected{% endif %}>Paired</option>
                </select>

                <label for="agent-team-{{ agent.id }}">Assigned team (optional)</label>
                <select id="agent-team-{{ agent.id }}" name="team_id">
                  <option value="">-- No team --</option>
                  {% for team_id, team_name in team_lookup.items() %}
                  <option value="{{ team_id }}" {% if agent.team_id == team_id %}selected{% endif %}>{{ team_name }}</option>
                  {% endfor %}
                </select>

                {% if free_agents_pending|length > 1 %}
                <label for="agent-pair-{{ agent.id }}">Create new team with</label>
                <select id="agent-pair-{{ agent.id }}" name="pair_with">
                  <option value="">-- Don't create new team --</option>
                  {% for other in free_agents_pending %}
                  {% if other.id != agent.id %}
                  <option value="{{ other.id }}">{{ other.name }}</option>
                  {% endif %}
                  {% endfor %}
                </select>
                <p class="form-hint">Pick another free agent to instantly form a new team.</p>
                {% endif %}

                <div class="inline-actions">
                  <button type="submit">Save changes</button>
                </div>
              </form>
              <form
                method="post"
                action="{{ request.url_for('delete_free_agent', agent_id=agent.id) }}"
                class="inline-form inline-form--danger"
                onsubmit="return confirm('Remove this free agent?');"
              >
                <button type="submit">Delete free agent</button>
              </form>
            </details>
          </li>
          {% endfor %}
        </ul>
        {% else %}
        <p class="empty-state">No free agents at the moment.</p>
        {% endif %}

        <h3>Recently paired</h3>
        {% if free_agents_paired %}
        <ul class="free-agent-list">
          {% for agent in free_agents_paired %}
          <li class="free-agent-list__item free-agent-list__item--paired">
            <div class="free-agent-card">
              <span class="free-agent-name">{{ agent.name }}</span>
              <span class="free-agent-meta">Now playing on {{ team_lookup.get(agent.team_id, 'a new team') }}</span>
            </div>
            <details class="inline-editor">
              <summary>Manage {{ agent.name }}</summary>
              <form method="post" action="{{ request.url_for('update_free_agent', agent_id=agent.id) }}" class="inline-form">
                <label for="agent-name-{{ agent.id }}">Full name</label>
                <input id="agent-name-{{ agent.id }}" name="name" type="text" value="{{ agent.name }}" required minlength="1" maxlength="100" />

                <label for="agent-note-{{ agent.id }}">Notes</label>
                <textarea id="agent-note-{{ agent.id }}" name="note" rows="2" maxlength="100">{{ agent.note or '' }}</textarea>

                <label for="agent-status-{{ agent.id }}">Status</label>
                <select id="agent-status-{{ agent.id }}" name="status">
                  <option value="pending" {% if agent.status == 'pending' %}selected{% endif %}>Pending</option>
                  <option value="paired" {% if agent.status == 'paired' %}selected{% endif %}>Paired</option>
                </select>

                <label for="agent-team-{{ agent.id }}">Assigned team (optional)</label>
                <select id="agent-team-{{ agent.id }}" name="team_id">
                  <option value="">-- No team --</option>
                  {% for team_id, team_name in team_lookup.items() %}
                  <option value="{{ team_id }}" {% if agent.team_id == team_id %}selected{% endif %}>{{ team_name }}</option>
                  {% endfor %}
                </select>

                {% if free_agents_pending %}
                <label for="agent-pair-{{ agent.id }}">Create new team with</label>
                <select id="agent-pair-{{ agent.id }}" name="pair_with">
                  <option value="">-- Don't create new team --</option>
                  {% for other in free_agents_pending %}
                  {% if other.id != agent.id %}
                  <option value="{{ other.id }}">{{ other.name }}</option>
                  {% endif %}
                  {% endfor %}
                </select>
                <p class="form-hint">Choose a pending free agent to regroup this player.</p>
                {% endif %}

                <div class="inline-actions">
                  <button type="submit">Save changes</button>
                </div>
              </form>
              <form
                method="post"
                action="{{ request.url_for('delete_free_agent', agent_id=agent.id) }}"
                class="inline-form inline-form--danger"
                onsubmit="return confirm('Remove this free agent?');"
              >
                <button type="submit">Delete free agent</button>
              </form>
            </details>
          </li>
          {% endfor %}
        </ul>
        {% else %}
        <p class="empty-state">No pairings yet.</p>
        {% endif %}
      </section>

      <section class="panel">
        <h2>Current Teams</h2>
        {% if teams %}
        <ul class="team-list" aria-live="polite">
          {% for team in teams %}
          <li class="team-list__item">
            <div class="team-list__header">
              <span class="team-list__name">{{ team.name }}</span>
              <span class="team-list__meta">Added to the roster</span>
            </div>
            {% if team.member_one or team.member_two %}
            <p class="team-list__members">
              <strong>Players:</strong>
              {{ team.member_one or 'TBD' }} &amp; {{ team.member_two or 'TBD' }}
            </p>
            {% endif %}
            <details class="inline-editor">
              <summary>Manage {{ team.name }}</summary>
              <form method="post" action="{{ request.url_for('update_team', team_id=team.id) }}" class="inline-form">
                <label for="team-edit-name-{{ team.id }}">Team name</label>
                <input
                  id="team-edit-name-{{ team.id }}"
                  name="name"
                  type="text"
                  value="{{ team.name }}"
                  minlength="2"
                  maxlength="100"
                  required
                />

                <label for="team-edit-member-one-{{ team.id }}">Player one</label>
                <input
                  id="team-edit-member-one-{{ team.id }}"
                  name="member_one"
                  type="text"
                  value="{{ team.member_one or '' }}"
                  maxlength="100"
                />

                <label for="team-edit-member-two-{{ team.id }}">Player two</label>
                <input
                  id="team-edit-member-two-{{ team.id }}"
                  name="member_two"
                  type="text"
                  value="{{ team.member_two or '' }}"
                  maxlength="100"
                />

                <div class="inline-actions">
                  <button type="submit">Save changes</button>
                </div>
              </form>
              <form
                method="post"
                action="{{ request.url_for('delete_team', team_id=team.id) }}"
                class="inline-form inline-form--danger"
                onsubmit="return confirm('Delete this team? Matches for the event will be regenerated.');"
              >
                <button type="submit">Delete team</button>
              </form>
            </details>
          </li>
          {% endfor %}
        </ul>
        {% else %}
        <p class="empty-state">
          No teams yet. Use the form to add your first entry—new teams will appear here instantly.
        </p>
        {% endif %}
      </section>

      {% if is_admin and blocked_teams %}
      <section class="panel panel--warning">
        <h2>Teams Awaiting Review</h2>
        <ul class="moderation-list">
          {% for team in blocked_teams %}
          <li class="moderation-list__item">
            <div>
              <strong>{{ team.name }}</strong>
              {% if team.member_one or team.member_two %}
              <p class="rsvp-meta">Members: {{ team.member_one or 'TBD' }} &amp; {{ team.member_two or 'TBD' }}</p>
              {% endif %}
            </div>
            <form method="post" action="{{ request.url_for('admin_approve_team', team_id=team.id) }}" class="moderation-approve">
              <input type="hidden" name="next" value="{{ request.url.path }}" />
              <button type="submit" class="btn-secondary">Approve Team</button>
            </form>
          </li>
          {% endfor %}
        </ul>
      </section>
      {% endif %}

      {% if is_admin and blocked_free_agents %}
      <section class="panel panel--warning">
        <h2>Free Agents Awaiting Review</h2>
        <ul class="moderation-list">
          {% for agent in blocked_free_agents %}
          <li class="moderation-list__item">
            <div>
              <strong>{{ agent.name }}</strong>
              {% if agent.note %}
              <p class="rsvp-note">“{{ agent.note }}”</p>
              {% endif %}
            </div>
            <form method="post" action="{{ request.url_for('admin_approve_free_agent', agent_id=agent.id) }}" class="moderation-approve">
              <input type="hidden" name="next" value="{{ request.url.path }}" />
              <button type="submit" class="btn-secondary">Approve Free Agent</button>
            </form>
          </li>
          {% endfor %}
        </ul>
      </section>
      {% endif %}
    </main>

    <footer class="page-footer">
      <p>
        Teams are stored in a local SQLite database (configurable via the <code>DATABASE_URL</code> env var).
      </p>
    </footer>
  </body>
</html>
