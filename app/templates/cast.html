<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>{{ cast_state.event.name }} â€¢ Live Cast</title>
    <link rel="icon" type="image/png" href="{{ request.url_for('static', path='img/freezefest-transparent.png') }}">
    <link rel="stylesheet" href="{{ request.url_for('static', path='css/style.css') }}?v={{ static_version }}">
  </head>
  <body class="cast-body">
    <main class="cast-layout">
      <div class="cast-top {% if not cast_state.semifinalists %}cast-top--solo{% endif %}">
        <section class="cast-photo">
          <div class="cast-photo__frame">
            {% if cast_state.photos %}
            <img
              src="{{ cast_state.photos[0].image_url }}"
              alt="Freeze Fest event highlight"
              loading="lazy"
              data-cast-photo
            />
            {% else %}
            <div class="cast-photo__placeholder" data-cast-photo-placeholder>
              <p>No photos yet. Upload highlights to start the slideshow.</p>
            </div>
            {% endif %}
          </div>
        </section>

        {% if cast_state.semifinalists %}
        <section class="cast-semis" aria-label="Leaderboard" data-cast-leaderboard>
          <header class="cast-semis__header">
            <div class="cast-semis__header-main">
              <h2>Leaderboard</h2>
              <p class="cast-semis__note">Top four advance</p>
            </div>
            {% if cast_state.generated_at %}
            <p class="cast-semis__updated" data-last-updated>Updated {{ cast_state.generated_at }}</p>
            {% endif %}
          </header>
          <div class="cast-semis__grid" data-cast-leaderboard-grid>
            {% set chunk_size = 4 %}
            {% set total = cast_state.semifinalists|length %}
            {% for start in range(0, total, chunk_size) %}
            <div class="cast-semis__col">
              {% for offset in range(chunk_size) %}
                {% set index = start + offset %}
                {% if index < total %}
                  {% set team = cast_state.semifinalists[index] %}
                  <div class="cast-semis__item {% if index < 4 %}cast-semis__item--qualified{% endif %}">
                    <span class="cast-semis__rank">#{{ index + 1 }}</span>
                    <div class="cast-semis__body">
                      {% set display_name = team.name[:17] ~ ('...' if team.name|length > 17 else '') %}
                      <p class="cast-semis__name-title">{{ display_name }}</p>
                      {% if cast_state.bucket_pool_mode %}
                        {% if team.bucket_score is not none %}
                        <p class="cast-semis__meta cast-semis__golf">Bucket score: {{ team.bucket_score }}</p>
                        {% else %}
                        <p class="cast-semis__meta cast-semis__golf">Bucket score: N/A</p>
                        {% endif %}
                      {% endif %}
                      <div class="cast-semis__record">
                        {% if team.wins is not none %}
                        <p class="cast-semis__meta">W: {{ team.wins }} / L: {{ team.losses }}</p>
                        {% if team.ties %}
                        <p class="cast-semis__meta">T: {{ team.ties }}</p>
                        {% endif %}
                        {% else %}
                        <p class="cast-semis__meta">W/L/T: --</p>
                        {% endif %}
                      </div>
                      {% if cast_state.bucket_pool_mode %}
                      <p class="cast-semis__meta cast-semis__bucket
                        {% if team.bucket_result == 'win' %}cast-semis__bucket--win
                        {% elif team.bucket_result == 'loss' %}cast-semis__bucket--loss
                        {% elif team.bucket_result == 'tie' %}cast-semis__bucket--tie
                        {% else %}cast-semis__bucket--pending{% endif %}">
                        {% if team.bucket_result == 'win' %}
                          +1 win via bucket score
                        {% elif team.bucket_result == 'loss' %}
                          +1 loss via bucket score
                        {% elif team.bucket_result == 'tie' %}
                          Bucket score counted as tie
                        {% else %}
                          Bucket score pending
                        {% endif %}
                      </p>
                      {% endif %}
                    </div>
                  </div>
                {% endif %}
              {% endfor %}
            </div>
            {% endfor %}
          </div>
        </section>
        {% endif %}
      </div>

      <section class="cast-grid" data-cast-games>
        {% if cast_state.games %}
          {% for item in cast_state.games %}
          <article class="cast-card" data-game-card>
            <h2>{{ item.game }}</h2>
              <div class="cast-card__section">
                <h3>Playing Now</h3>
                {% if item.current %}
                <ul class="cast-card__matches" data-role="current">
                  {% for current in item.current %}
                  <li>
                    {% if current.pool_group %}
                      {{ current.pool_group|join(' + ') }}
                    {% elif current.pool_pair and current.team2 %}
                      {{ current.team1 }} + {{ current.team2 }}
                    {% elif current.is_bye %}
                      {{ current.team1 }} (solo run)
                    {% elif current.team2 %}
                      {{ current.team1 }} vs {{ current.team2 }}
                    {% else %}
                      {{ current.team1 }}
                    {% endif %}
                  </li>
                  {% endfor %}
                </ul>
                {% else %}
                <p class="cast-card__value">
                  {% if item.remaining == 0 %}
                    All matches complete
                  {% else %}
                    Waiting for the next teams
                  {% endif %}
                </p>
                {% endif %}
              </div>
              <div class="cast-card__section">
                <h3>Upcoming Games</h3>
                {% if item.next %}
                <p class="cast-card__value" data-role="next">
                  {% if item.next.pool_group %}
                    {{ item.next.pool_group|join(' + ') }}
                  {% elif item.next.pool_pair and item.next.team2 %}
                    {{ item.next.team1 }} + {{ item.next.team2 }}
                  {% elif item.next.is_bye %}
                    {{ item.next.team1 }} (solo run)
                  {% elif item.next.team2 %}
                    {{ item.next.team1 }} vs {{ item.next.team2 }}
                  {% else %}
                    {{ item.next.team1 }}
                  {% endif %}
                </p>
                {% endif %}
                {% if item.upcoming_queue %}
                <ul class="cast-card__queue">
                  {% for upcoming in item.upcoming_queue %}
                  <li>
                    {% if upcoming.pool_group %}
                      {{ upcoming.pool_group|join(' + ') }}
                    {% elif upcoming.pool_pair and upcoming.team2 %}
                      {{ upcoming.team1 }} + {{ upcoming.team2 }}
                    {% elif upcoming.is_bye %}
                      {{ upcoming.team1 }} (solo run)
                    {% elif upcoming.team2 %}
                      {{ upcoming.team1 }} vs {{ upcoming.team2 }}
                    {% else %}
                      {{ upcoming.team1 }}
                    {% endif %}
                  </li>
                  {% endfor %}
                </ul>
                {% elif not item.next %}
                <p class="cast-card__value">
                  {% if item.remaining == 0 %}
                    Tournament finished for this game
                  {% else %}
                    Stand by for assignments
                  {% endif %}
                </p>
                {% endif %}
              </div>
          </article>
          {% endfor %}
        {% else %}
          {% if cast_state.final_match %}
          <article class="cast-card" data-game-card>
            <h2>Final Match</h2>
            <p class="cast-card__value">
              {{ cast_state.final_match.team1 }} vs {{ cast_state.final_match.team2 }}
            </p>
            {% if cast_state.final_match.score1 is not none and cast_state.final_match.score2 is not none %}
            <p class="cast-card__value">Score: {{ cast_state.final_match.score1 }} - {{ cast_state.final_match.score2 }}</p>
            {% else %}
            <p class="cast-card__value">{{ cast_state.final_match.status|title }}</p>
            {% endif %}
          </article>
          {% endif %}
          <article class="cast-card cast-card--empty" data-game-card>
            <h2>Matches</h2>
            <p class="cast-card__value">Match assignments will appear here as soon as the tournament begins.</p>
          </article>
        {% endif %}
      </section>
    </main>

    <script>
      window.CAST_STATE = {{ cast_state | tojson }};
    </script>
    <script src="https://www.gstatic.com/cast/sdk/libs/caf_receiver/v3/cast_receiver_framework.js" defer></script>
    <script src="{{ request.url_for('static', path='js/cast.js') }}?v={{ static_version }}" defer></script>
    <script>
      window.addEventListener("load", () => {
        const hasCastFramework = window.cast && window.cast.framework;
        if (!hasCastFramework) {
          return;
        }

        const context = window.cast.framework.CastReceiverContext.getInstance();
        const KEEPALIVE_AUDIO_BASE64 = "UklGRiQAAABXQVZFZm10IBAAAAABAAEAQB8AAIA+AAACABAAZGF0YQAAAAA=";
        const createKeepAliveUrl = () => {
          try {
            const binary = atob(KEEPALIVE_AUDIO_BASE64);
            const bytes = new Uint8Array(binary.length);
            for (let i = 0; i < binary.length; i += 1) {
              bytes[i] = binary.charCodeAt(i);
            }
            const blob = new Blob([bytes], { type: "audio/wav" });
            const url = URL.createObjectURL(blob);
            window.addEventListener(
              "unload",
              () => {
                URL.revokeObjectURL(url);
              },
              { once: true }
            );
            return url;
          } catch (error) {
            console.warn("Failed to build keep-alive audio", error);
            return null;
          }
        };

        const startKeepAlivePlayback = () => {
          const playerManager = context.getPlayerManager();
          const keepAliveUrl = createKeepAliveUrl();
          if (!playerManager || !keepAliveUrl) {
            return;
          }

          const loadKeepAlive = () => {
            const mediaInfo = new cast.framework.messages.MediaInformation();
            mediaInfo.contentId = keepAliveUrl;
            mediaInfo.contentType = "audio/wav";
            mediaInfo.streamType = cast.framework.messages.StreamType.BUFFERED;
            const loadRequest = new cast.framework.messages.LoadRequestData();
            loadRequest.media = mediaInfo;
            loadRequest.autoplay = true;
            playerManager.load(loadRequest).catch((error) => {
              console.warn("Keep-alive load failed", error);
            });
          };

          playerManager.addEventListener(
            cast.framework.events.EventType.MEDIA_FINISHED,
            () => loadKeepAlive()
          );
          playerManager.addEventListener(cast.framework.events.EventType.ERROR, () => {
            window.setTimeout(loadKeepAlive, 2000);
          });

          loadKeepAlive();
        };
        const heartbeatNamespace = "urn:x-cast:freeze.heartbeat";
        context.addCustomMessageListener(heartbeatNamespace, (event) => {
          if (event && event.senderId) {
            context.sendCustomMessage(heartbeatNamespace, event.senderId, { pong: Date.now() });
          }
        });
        context.setInactivityTimeout(0); // legacy safeguard
        const receiverOptions = new window.cast.framework.CastReceiverOptions();
        receiverOptions.statusText = "Freeze Fest Live";
        receiverOptions.maxInactivity = 3600;
        receiverOptions.disableIdleTimeout = true;
        context.start(receiverOptions);
        startKeepAlivePlayback();
      });
    </script>
  </body>
</html>
