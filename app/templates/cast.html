<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>{{ cast_state.event.name }} â€¢ Live Cast</title>
    <link rel="icon" type="image/png" href="{{ request.url_for('static', path='img/freezefest-transparent.png') }}">
    <link rel="stylesheet" href="{{ request.url_for('static', path='css/style.css') }}">
  </head>
  <body class="cast-body">
    <main class="cast-layout">
      <section class="cast-photo">
        <div class="cast-photo__frame">
          {% if cast_state.photos %}
          <img
            src="{{ cast_state.photos[0].image_url }}"
            alt="Freeze Fest event highlight"
            loading="lazy"
            data-cast-photo
          />
          {% else %}
          <div class="cast-photo__placeholder" data-cast-photo-placeholder>
            <p>No photos yet. Upload highlights to start the slideshow.</p>
          </div>
          {% endif %}
        </div>
      </section>

      <aside class="cast-info">
        <div class="cast-info__summary">
          <header class="cast-info__header cast-info__header--stacked">
            <div class="cast-info__titles">
              <h1>{{ cast_state.event.name }}</h1>
            </div>
            <div class="cast-info__logo">
              <img src="{{ request.url_for('static', path='img/freezefest-transparent.png') }}" alt="Freeze Fest mascot" />
            </div>
          </header>

          {% if cast_state.semifinalists %}
          <section class="cast-semis" aria-label="Leaderboard">
            <header class="cast-semis__header">
              <h2>Leaderboard</h2>
              <span class="cast-semis__note">Top four in semifinals</span>
            </header>
            <ol class="cast-semis__list">
              {% for team in cast_state.semifinalists %}
              <li class="cast-semis__item {% if loop.index <= 4 %}cast-semis__item--qualified{% endif %}">
                <span class="cast-semis__rank">#{{ loop.index }}</span>
                <div class="cast-semis__body">
                  <div class="cast-semis__headline">
                    <div class="cast-semis__name">
                      <p class="cast-semis__name-title">{{ team.name }}</p>
                      {% if cast_state.bucket_pool_mode %}
                        {% if team.bucket_score is not none %}
                        <p class="cast-semis__meta cast-semis__golf">Golf Strokes: {{ team.bucket_score }}</p>
                        {% else %}
                        <p class="cast-semis__meta cast-semis__golf">Golf incomplete</p>
                        {% endif %}
                      {% endif %}
                    </div>
                    <div class="cast-semis__record">
                      {% if team.wins is not none %}
                      <p class="cast-semis__meta">Win: {{ team.wins }}</p>
                      <p class="cast-semis__meta">Loss: {{ team.losses }}</p>
                      {% if team.ties %}
                      <p class="cast-semis__meta">Ties: {{ team.ties }}</p>
                      {% endif %}
                      {% else %}
                      <p class="cast-semis__meta">Win: --</p>
                      <p class="cast-semis__meta">Loss: --</p>
                      <p class="cast-semis__meta">Ties: --</p>
                      {% endif %}
                    </div>
                  </div>
                </div>
              </li>
              {% endfor %}
            </ol>
          </section>
          {% endif %}
        </div>

        <section class="cast-games" data-cast-games>
          {% if cast_state.games %}
            {% for item in cast_state.games %}
            <article class="cast-card">
              <h2>{{ item.game }}</h2>
              <div class="cast-card__section">
                <h3>Playing Now</h3>
                {% if item.current %}
                <ul class="cast-card__matches" data-role="current">
                  {% for current in item.current %}
                  <li>
                    {% if current.pool_group %}
                      {{ current.pool_group|join(' + ') }}
                    {% elif current.pool_pair and current.team2 %}
                      {{ current.team1 }} + {{ current.team2 }}
                    {% elif current.is_bye %}
                      {{ current.team1 }} (solo run)
                    {% elif current.team2 %}
                      {{ current.team1 }} vs {{ current.team2 }}
                    {% else %}
                      {{ current.team1 }}
                    {% endif %}
                  </li>
                  {% endfor %}
                </ul>
                {% else %}
                <p class="cast-card__value">
                  {% if item.remaining == 0 %}
                    All matches complete
                  {% else %}
                    Waiting for the next teams
                  {% endif %}
                </p>
                {% endif %}
              </div>
              <div class="cast-card__section">
                <h3>Upcoming Games</h3>
                {% if item.next %}
                <p class="cast-card__value" data-role="next">
                  {% if item.next.pool_group %}
                    {{ item.next.pool_group|join(' + ') }}
                  {% elif item.next.pool_pair and item.next.team2 %}
                    {{ item.next.team1 }} + {{ item.next.team2 }}
                  {% elif item.next.is_bye %}
                    {{ item.next.team1 }} (solo run)
                  {% elif item.next.team2 %}
                    {{ item.next.team1 }} vs {{ item.next.team2 }}
                  {% else %}
                    {{ item.next.team1 }}
                  {% endif %}
                </p>
                {% endif %}
                {% if item.upcoming_queue %}
                <ul class="cast-card__queue">
                  {% for upcoming in item.upcoming_queue %}
                  <li>
                    {% if upcoming.pool_group %}
                      {{ upcoming.pool_group|join(' + ') }}
                    {% elif upcoming.pool_pair and upcoming.team2 %}
                      {{ upcoming.team1 }} + {{ upcoming.team2 }}
                    {% elif upcoming.is_bye %}
                      {{ upcoming.team1 }} (solo run)
                    {% elif upcoming.team2 %}
                      {{ upcoming.team1 }} vs {{ upcoming.team2 }}
                    {% else %}
                      {{ upcoming.team1 }}
                    {% endif %}
                  </li>
                  {% endfor %}
                </ul>
                {% elif not item.next %}
                <p class="cast-card__value">
                  {% if item.remaining == 0 %}
                    Tournament finished for this game
                  {% else %}
                    Stand by for assignments
                  {% endif %}
                </p>
                {% endif %}
              </div>
            </article>
            {% endfor %}
          {% else %}
            <article class="cast-card cast-card--empty">
              <h2>Matches</h2>
              <p class="cast-card__value">Match assignments will appear here as soon as the tournament begins.</p>
            </article>
          {% endif %}
        </section>
      </aside>
    </main>

    <script>
      window.CAST_STATE = {{ cast_state | tojson }};
    </script>
    <script src="https://www.gstatic.com/cast/sdk/libs/caf_receiver/v3/cast_receiver_framework.js" defer></script>
    <script src="{{ request.url_for('static', path='js/cast.js') }}" defer></script>
    <script>
      window.addEventListener("load", () => {
        const hasCastFramework = window.cast && window.cast.framework;
        if (!hasCastFramework) {
          return;
        }

        const context = window.cast.framework.CastReceiverContext.getInstance();
        const heartbeatNamespace = "urn:x-cast:freeze.heartbeat";
        context.addCustomMessageListener(heartbeatNamespace, () => {
          // Heartbeat received; no action needed beyond keeping session active.
        });
        context.setInactivityTimeout(0); // legacy safeguard
        const receiverOptions = new window.cast.framework.CastReceiverOptions();
        receiverOptions.statusText = "Freeze Fest Live";
        receiverOptions.maxInactivity = 3600;
        receiverOptions.disableIdleTimeout = true;
        context.start(receiverOptions);
      });
    </script>
  </body>
</html>
